<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Plant Layout Editor</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>
<body class="container py-4">
  <div class="top-bar mb-3" style="display: flex; justify-content: flex-end;">
    <a href="engineer.html" class="btn btn-outline-secondary">Back to engineer menu</a>
  </div>
  <h2 class="mb-4">Plant Layout Editor</h2>
  <form class="mb-4">
    <div class="mb-3">
      <label for="customerSelect" class="form-label">Select customer</label>
      <select id="customerSelect" class="form-select"></select>
    </div>
    <div class="mb-3">
      <label for="plantSelect" class="form-label">Select plant</label>
      <select id="plantSelect" class="form-select" disabled></select>
    </div>
    <button id="goToLineCreate" class="btn btn-success" type="button" disabled style="display:none;">Create line for plant</button>
  </form>
  <div id="linesSection"></div>
  </form>
  <script>
    // Fetch customers
    fetch('http://localhost:8000/customers')
      .then(r => r.json())
      .then(customers => {
        const sel = document.getElementById('customerSelect');
        sel.innerHTML = '<option value="">Choose...</option>' + customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
      });

    // Fetch plants for selected customer
    document.getElementById('customerSelect').addEventListener('change', function() {
      const customerId = this.value;
      const plantSel = document.getElementById('plantSelect');
      document.getElementById('goToLineCreate').disabled = true;
      document.getElementById('goToLineCreate').style.display = 'none';
      document.getElementById('linesSection').innerHTML = '';
      if (!customerId) {
        plantSel.innerHTML = '';
        plantSel.disabled = true;
        return;
      }
      fetch(`http://localhost:8000/customers/${customerId}/plants`)
        .then(r => r.json())
        .then(plants => {
          plantSel.innerHTML = '<option value="">Choose...</option>' + plants.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
          plantSel.disabled = false;
        });
    });

    // When plant selected, fetch lines for plant
    document.getElementById('plantSelect').addEventListener('change', function() {
      const plantId = this.value;
      document.getElementById('goToLineCreate').disabled = !plantId;
      localStorage.setItem('selectedPlantId', plantId || '');
      const linesSection = document.getElementById('linesSection');
      linesSection.innerHTML = '';
      if (!plantId) {
        document.getElementById('goToLineCreate').style.display = 'none';
        return;
      }
      // Fetch lines for this plant
      fetch(`http://localhost:8000/plants/${plantId}/lines`)
        .then(r => r.json())
        .then(lines => {
          if (lines.length === 0) {
            linesSection.innerHTML = '<div class="alert alert-info">No lines found for this plant.</div>';
            document.getElementById('goToLineCreate').style.display = '';
          } else {
            let html = `<h5>Existing lines for this plant</h5><table class=\"table table-bordered\"><thead><tr><th>ID</th><th>Line number</th><th>min_x</th><th>max_x</th><th>min_y</th><th>max_y</th><th>Delete</th></tr></thead><tbody>`;
            for (const line of lines) {
              html += `<tr><td>${line.id}</td><td>${line.line_number}</td><td>${line.min_x}</td><td>${line.max_x}</td><td>${line.min_y}</td><td>${line.max_y}</td><td><button class='btn btn-danger btn-sm' onclick='deleteLine(${line.id}, this)'>Delete</button></td></tr>`;
              // Tankit tälle linjalle, vasemmalle puolelle
              html += `<tr><td colspan='7'><div style='display:flex;'><div id='tanks-for-line-${line.id}' style='width:50%;'></div><div style='width:50%;'></div></div></td></tr>`;
            }
            html += '</tbody></table>';
            linesSection.innerHTML = html;
            // Hae tankit jokaiselle linjalle
            for (const line of lines) {
              fetch(`http://localhost:8000/lines/${line.id}/tanks`)
                .then(r => r.json())
                .then(tanks => {
                  let tanksHtml = '';
                  if (tanks.length === 0) {
                    tanksHtml = '<em>No tanks for this line.</em>';
                  } else {
                    tanksHtml = `<b>Tanks:</b> <table class='table table-sm table-striped'><thead><tr><th>#</th><th>Name</th><th>Edit</th><th>Delete</th></tr></thead><tbody>`;
                    for (const t of tanks) {
                      tanksHtml += `<tr><td>${t.tank_number}</td><td><span class='tank-name' data-tankid='${t.id}'>${t.tank_name}</span></td><td><button class='btn btn-sm btn-outline-primary' onclick='editTankName(${t.id}, this)'>Edit</button></td><td><button class='btn btn-sm btn-outline-danger' onclick='deleteTank(${t.id}, ${t.tank_group_id}, this)'>Delete</button></td></tr>`;
                    }
                    tanksHtml += '</tbody></table>';
                  }
                  document.getElementById(`tanks-for-line-${line.id}`).innerHTML = tanksHtml;
                });
            }
            // Edit tank name
            window.editTankName = function(tankId, btn) {
              const span = btn.parentElement.parentElement.querySelector('.tank-name');
              const oldName = span.textContent;
              const input = document.createElement('input');
              input.type = 'text';
              input.value = oldName;
              input.className = 'form-control form-control-sm';
              span.replaceWith(input);
              btn.textContent = 'Save';
              btn.onclick = function() {
                fetch(`http://localhost:8000/tanks/${tankId}`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ tank_name: input.value })
                })
                .then(r => {
                  if (r.ok) {
                    input.replaceWith(Object.assign(document.createElement('span'), {className:'tank-name', textContent: input.value, dataset:{tankid:tankId}}));
                    btn.textContent = 'Edit';
                    btn.onclick = function() { window.editTankName(tankId, btn); };
                  } else {
                    alert('Update failed');
                  }
                });
              };
            };
            // Delete tank
            window.deleteTank = function(tankId, tankGroupId, btn) {
              if (!confirm('Delete this tank (and its group if only one tank)?')) return;
              fetch(`http://localhost:8000/tanks/${tankId}/can_delete`)
                .then(r => r.json())
                .then(res => {
                  if (res.can_delete) {
                    fetch(`http://localhost:8000/tanks/${tankId}`, { method: 'DELETE' })
                      .then(r => {
                        if (r.ok) {
                          // Poista rivi taulukosta
                          btn.parentElement.parentElement.remove();
                        } else {
                          alert('Delete failed');
                        }
                      });
                  } else {
                    alert('Cannot delete: tank group has more than one tank or tank is referenced elsewhere.');
                  }
                });
            };
            document.getElementById('goToLineCreate').style.display = 'none';
            // Lisää deleteLine-funktio
            window.deleteLine = function(lineId, btn) {
              if (!confirm('Delete this line?')) return;
              btn.disabled = true;
              fetch(`http://localhost:8000/lines/${lineId}`, { method: 'DELETE' })
                .then(r => {
                  if (r.ok) {
                    btn.closest('tr').remove();
                  } else {
                    r.json().then(data => alert(data.detail || 'Delete failed'));
                    btn.disabled = false;
                  }
                })
                .catch(() => {
                  alert('Delete failed');
                  btn.disabled = false;
                });
            }
          }
        })
        .catch(() => {
          linesSection.innerHTML = '<div class="alert alert-danger">Error fetching lines.</div>';
        });
    });

    document.getElementById('goToLineCreate').addEventListener('click', function() {
      window.location.href = 'plant_line_create.html';
    });
  </script>
</body>
</html>
